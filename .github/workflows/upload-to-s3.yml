name: Upload to S3 and Deploy to ASG

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout code
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: wordpress

      # 2️⃣ Create tar.gz and upload to S3
      - name: Create and upload archive to S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          DATE=$(date +%Y-%m-%d_%H-%M-%S)
          FILENAME="app_${DATE}.tar.gz"

          echo "Creating archive: $FILENAME"
          tar -czf "${FILENAME}" -C wordpress .

          echo "Uploading to S3..."
          aws s3 cp "${FILENAME}" "s3://${{ secrets.S3_BUCKET }}/${FILENAME}"

          # Export filename for next step
          echo "FILENAME=${FILENAME}" >> $GITHUB_ENV

      # 3️⃣ Deploy to ASG via SSM
      - name: Deploy to ASG via SSM
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          FILENAME: ${{ env.FILENAME }}
        run: |
          echo "Sending SSM command to deploy build..."
          
          aws ssm send-command \
            --targets "Key=tag:Role,Values=app" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy WordPress update" \
            --parameters '{"commands":["sudo yum install -y awscli rsync tar","sudo aws s3 cp s3://'"${S3_BUCKET}"'/'"${FILENAME}"' /tmp/app.tar.gz","sudo mkdir -p /tmp/app","sudo tar -xzf /tmp/app.tar.gz -C /tmp/app","sudo rsync -av --delete /tmp/app/ /var/www/html/","sudo chown -R apache:apache /var/www/html/","echo Deployment complete, listing /var/www/html:","ls -l /var/www/html"]}'
